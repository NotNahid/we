<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Immersive Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0a0a0a;
            background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #0a0a0a 70%);
            background-attachment: fixed;
            color: #f8fafc;
            overflow-x: hidden;
            overscroll-behavior-y: none;
            position: relative;
            touch-action: pan-y;
        }

        /* Ambient animated background */
        body::before {
            content: '';
            position: fixed;
            top: -20%;
            left: -20%;
            width: 140%;
            height: 140%;
            background: radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.02) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
            transform: translate3d(0,0,0); 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 15, 15, 1); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* Masonry Grid Layout */
        .masonry-grid {
            column-count: 3;
            column-gap: 0.75rem;
            position: relative;
            z-index: 1;
        }
        
        @media (min-width: 640px) { .masonry-grid { column-count: 3; column-gap: 1rem; } }
        @media (min-width: 768px) { .masonry-grid { column-count: 4; } }
        @media (min-width: 1200px) { .masonry-grid { column-count: 5; } }

        .gallery-item {
            break-inside: avoid;
            margin-bottom: 0.75rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
            content-visibility: auto; 
            contain-intrinsic-size: 300px; 
        }
        
        @media (min-width: 640px) { .gallery-item { margin-bottom: 1rem; } }

        .gallery-item.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .gallery-card {
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            background: #151515;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .gallery-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.03);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        @media (hover: hover) {
            .gallery-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
                border-color: rgba(255, 255, 255, 0.15);
            }
            .gallery-card:hover::after { opacity: 1; }
            .gallery-card:hover img { transform: scale(1.05); }
        }

        .gallery-card img {
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: block;
            width: 100%;
            height: auto;
            aspect-ratio: attr(width) / attr(height); 
        }

        /* Lightbox Container */
        #lightbox {
            transition: background-color 0.2s ease, backdrop-filter 0.2s ease;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.9);
            touch-action: none; 
        }
        
        #lightbox.dragging {
            transition: none; 
        }

        /* Slide Container */
        .slide-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        /* Lightbox Image */
        .lightbox-image {
            position: absolute;
            max-width: 100%;
            max-height: 100%; 
            object-fit: contain;
            will-change: transform;
            user-select: none;
            -webkit-user-drag: none;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }
        
        .lightbox-image.zoomed {
            cursor: move; /* Fallback */
            cursor: zoom-out;
            z-index: 50;
            max-width: none;
            max-height: none;
            /* Important: Transition must match the mouse tracking update speed or be removed for tracking */
        }
        
        .lightbox-image.dragging {
            transition: none !important;
        }

        .ui-element {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .ui-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .control-btn {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(8px); 
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .control-btn:active { transform: scale(0.90); }

        #backToTop {
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: all 0.3s ease;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        #backToTop.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .counter-badge {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
        }

    </style>
</head>
<body class="min-h-screen">

    <main class="pt-4 pb-16 px-2 sm:px-6 max-w-[1920px] mx-auto min-h-screen">
        <div id="galleryGrid" class="masonry-grid"></div>
    </main>

    <button id="backToTop" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 right-6 z-30 w-12 h-12 rounded-full flex items-center justify-center text-white/80 shadow-xl active:scale-90">
        <i class="fa-solid fa-arrow-up text-lg"></i>
    </button>

    <div id="lightbox" class="fixed inset-0 z-50 hidden opacity-0 outline-none" tabindex="-1" aria-modal="true">
        
        <div id="lightboxHeader" class="ui-element absolute top-0 left-0 right-0 p-4 z-[60] flex justify-between items-start pointer-events-none transition-opacity duration-300">
            <div class="counter-badge px-3 py-1.5 rounded-full pointer-events-auto shadow-lg">
                <span id="lightboxCounter" class="text-white/90 text-xs font-mono tracking-widest font-bold"></span>
            </div>

            <div class="flex gap-3 pointer-events-auto">
                <button id="downloadBtn" onclick="downloadCurrentImage()" class="control-btn w-10 h-10 flex items-center justify-center rounded-full text-white/90" title="Download">
                    <i class="fa-solid fa-download text-sm"></i>
                </button>
                <button id="closeLightbox" class="control-btn w-10 h-10 flex items-center justify-center rounded-full text-white/90" title="Close">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
        </div>

        <button id="prevBtn" class="nav-arrow ui-element absolute left-4 top-1/2 -translate-y-1/2 z-50 p-4 focus:outline-none cursor-pointer">
             <div class="control-btn w-12 h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white transition-colors">
                <i class="fa-solid fa-chevron-left text-lg"></i>
             </div>
        </button>

        <button id="nextBtn" class="nav-arrow ui-element absolute right-4 top-1/2 -translate-y-1/2 z-50 p-4 focus:outline-none cursor-pointer">
             <div class="control-btn w-12 h-12 flex items-center justify-center rounded-full text-white/70 hover:text-white transition-colors">
                <i class="fa-solid fa-chevron-right text-lg"></i>
             </div>
        </button>

        <div id="imageContainer" class="slide-container w-full h-full p-0 md:p-8"></div>
        
    </div>

    <script>
        // Data
        const rawLinksString = `
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330181349_cujcps?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330181247_jmt771?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330181244_qdnf28?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175443_lwbi2t?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175422_ail1v5?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175409_eov58b?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175409_01_lpvlx3?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175403_ouecza?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330175100_ipcwdi?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174941_gmqemx?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174907_rywnk4?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174831_txwygn?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174828_crpp4d?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174704_woumgs?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174649_v07osw?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174641_fgbtee?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174537_bpkygb?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174355_c48ffc?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174252_nmbpli?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174246_ebhgrw?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174135_jwfnaz?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174119_rz1ang?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330174113_tgk1gv?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330173939_ueyab8?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330173934_ox1lpw?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330173732_sdxpys?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330173727_pubm2z?_a=BAMAMiTI0
https://res.cloudinary.com/da54i7wj7/image/upload/f_auto,q_auto/IMG20200330173725_jmhrxs?_a=BAMAMiTI0
        `;
        
        const galleryData = rawLinksString.split('\n').map(l => l.trim()).filter(l => l.length > 0).map((url, i) => ({ id: i, url }));

        const grid = document.getElementById('galleryGrid');
        const lightbox = document.getElementById('lightbox');
        const imageContainer = document.getElementById('imageContainer');
        const lightboxCounter = document.getElementById('lightboxCounter');
        const backToTopBtn = document.getElementById('backToTop');
        const uiElements = document.querySelectorAll('.ui-element');
        
        let currentIdx = -1;
        let isDownloading = false;
        let isUiVisible = true;
        
        // State
        let touchStart = { x: 0, y: 0, time: 0 };
        let touchCurrent = { x: 0, y: 0 };
        let isDragging = false;
        let isZoomed = false;
        let lastTapTime = 0;
        let activeImage = null;
        let transitionTimeout = null;

        function renderGallery() {
            grid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            galleryData.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'gallery-item';
                let thumbnailUrl = item.url;
                if (thumbnailUrl.includes('cloudinary.com') && thumbnailUrl.includes('/upload/')) {
                    thumbnailUrl = thumbnailUrl.replace('/upload/', '/upload/w_500,c_scale/');
                }

                card.innerHTML = `
                    <div class="gallery-card cursor-pointer" onclick="openLightbox(${index})">
                         <div class="relative overflow-hidden bg-[#1a1a1a] aspect-[3/4]"> 
                            <img src="${thumbnailUrl}" alt="Gallery image" loading="lazy"
                                onload="this.closest('.gallery-item').classList.add('visible'); this.parentElement.classList.remove('aspect-[3/4]')">
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            grid.appendChild(fragment);
        }

        function openLightbox(index) {
            currentIdx = index;
            history.pushState({ galleryOpen: true }, '', '');
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            isUiVisible = true;
            toggleUi(true);
            requestAnimationFrame(() => {
                lightbox.classList.remove('opacity-0');
                updateImage();
            });
        }

        function closeLightbox() {
            history.back();
        }

        function dismissLightbox() {
            lightbox.classList.add('opacity-0');
            setTimeout(() => {
                lightbox.classList.add('hidden');
                imageContainer.innerHTML = '';
                activeImage = null;
                isZoomed = false;
            }, 300);
            document.body.style.overflow = '';
        }

        window.addEventListener('popstate', (event) => {
            if (!lightbox.classList.contains('hidden')) dismissLightbox();
        });

        function updateImage(direction = 'none') {
            lightboxCounter.textContent = `${currentIdx + 1} / ${galleryData.length}`;
            if(galleryData[currentIdx + 1]) new Image().src = galleryData[currentIdx + 1].url;
            if(galleryData[currentIdx - 1]) new Image().src = galleryData[currentIdx - 1].url;

            const currentImg = imageContainer.querySelector('.lightbox-image:not(.exiting)');
            if (currentImg) {
                currentImg.classList.add('exiting');
                currentImg.classList.remove('zoomed');
                currentImg.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
                if (direction === 'next') currentImg.style.transform = 'translateX(-50px) scale(0.95)';
                else if (direction === 'prev') currentImg.style.transform = 'translateX(50px) scale(0.95)';
                currentImg.style.opacity = '0';
                setTimeout(() => currentImg.remove(), 350);
            }

            const img = document.createElement('img');
            img.src = galleryData[currentIdx].url;
            img.className = 'lightbox-image';
            img.draggable = false;
            
            img.style.opacity = '0';
            if (direction === 'next') img.style.transform = 'translateX(50px) scale(0.95)';
            else if (direction === 'prev') img.style.transform = 'translateX(-50px) scale(0.95)';
            else img.style.transform = 'scale(0.95)';

            addGestureListeners(img);
            imageContainer.appendChild(img);
            activeImage = img;
            isZoomed = false;

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    img.style.opacity = '1';
                    img.style.transform = 'translateX(0) scale(1)';
                });
            });
        }

        function next() {
            if (currentIdx < galleryData.length - 1) { currentIdx++; updateImage('next'); }
            else { bounce('left'); }
        }

        function prev() {
            if (currentIdx > 0) { currentIdx--; updateImage('prev'); }
            else { bounce('right'); }
        }

        function bounce(dir) {
            if(activeImage) {
                activeImage.style.transform = dir === 'left' ? 'translateX(-50px)' : 'translateX(50px)';
                setTimeout(() => activeImage.style.transform = 'translateX(0)', 150);
            }
        }

        function toggleUi(forceState) {
            isUiVisible = forceState !== undefined ? forceState : !isUiVisible;
            uiElements.forEach(el => {
                if (isUiVisible) el.classList.remove('ui-hidden');
                else el.classList.add('ui-hidden');
            });
        }

        // --- RESTORED SMART ZOOM SYSTEM ---

        function addGestureListeners(el) {
            el.addEventListener('touchstart', handleTouchStart, { passive: false });
            el.addEventListener('touchmove', handleTouchMove, { passive: false });
            el.addEventListener('touchend', handleTouchEnd);
            el.addEventListener('click', handleClick); 
        }

        function handleClick(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            
            if (tapLength < 300 && tapLength > 0) {
                // Double Tap triggers Smart Zoom
                toggleZoom(e);
                e.preventDefault();
            } else {
                // Single Tap - UI Toggle
                setTimeout(() => {
                    if (new Date().getTime() - lastTapTime >= 300 && !isZoomed) {
                        toggleUi();
                    }
                }, 300);
            }
            lastTapTime = currentTime;
        }

        function toggleZoom(e) {
            if (!activeImage) return;

            // 1. Get exact click coordinates (Mouse or Touch)
            let clientX, clientY;
            if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            if (isZoomed) {
                // Zoom Out - Reset to clean state
                activeImage.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
                activeImage.style.transform = 'translate(0, 0) scale(1)';
                // Important: Reset origin after transition or it looks weird
                setTimeout(() => {
                    if (!isZoomed) activeImage.style.transformOrigin = 'center center';
                }, 300);
                activeImage.classList.remove('zoomed');
                activeImage.onmousemove = null; // Remove mouse tracking
                isZoomed = false;
            } else {
                // Zoom In - The "Smart" Way
                const rect = activeImage.getBoundingClientRect();
                
                // If coordinates are missing (e.g. called programmatically), center it
                if (!clientX) {
                    clientX = rect.left + rect.width / 2;
                    clientY = rect.top + rect.height / 2;
                }

                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                // Calculate percentage position of click/tap
                const xPercent = (x / rect.width) * 100;
                const yPercent = (y / rect.height) * 100;

                // Set origin point instantly
                activeImage.style.transformOrigin = `${xPercent}% ${yPercent}%`;
                activeImage.classList.add('zoomed');
                activeImage.style.transition = 'transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)';
                activeImage.style.transform = 'scale(2.5)';
                isZoomed = true;
                toggleUi(false); 

                // RESTORED: Mouse Tracking Logic (Desktop Pan)
                activeImage.onmousemove = function(e) {
                    const w = activeImage.offsetWidth;
                    const h = activeImage.offsetHeight;
                    const xP = (e.offsetX / w) * 100;
                    const yP = (e.offsetY / h) * 100;
                    
                    // Update the view based on mouse position
                    // We reduce transition time to 0 while tracking for instant response
                    activeImage.style.transition = 'none'; 
                    activeImage.style.transformOrigin = `${xP}% ${yP}%`;
                }
            }
        }

        function handleTouchStart(e) {
            if (e.touches.length > 1) return;
            isDragging = true;
            touchStart.x = e.touches[0].clientX;
            touchStart.y = e.touches[0].clientY;
            touchStart.time = new Date().getTime();
            
            // If zoomed, we don't drag-to-dismiss, we pan (native behavior or custom)
            if (!isZoomed && activeImage) activeImage.classList.add('dragging');
            if (!isZoomed) lightbox.classList.add('dragging');
        }

        function handleTouchMove(e) {
            // Disable custom swipe logic if zoomed (let browser handle standard pan if possible, or lock it)
            if (!isDragging || !activeImage) return;
            
            touchCurrent.x = e.touches[0].clientX;
            touchCurrent.y = e.touches[0].clientY;
            
            const diffX = touchCurrent.x - touchStart.x;
            const diffY = touchCurrent.y - touchStart.y;
            
            // Allow default scrolling if zoomed (so user can pan around the zoomed image)
            if (isZoomed) return;

            e.preventDefault();

            // Swipe to Dismiss (Vertical)
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 10) {
                const resistance = 0.5;
                const translateY = diffY * resistance;
                activeImage.style.transform = `translateY(${translateY}px) scale(${1 - Math.abs(diffY)/1000})`;
                const opacity = Math.max(0, 1 - Math.abs(diffY) / 300);
                lightbox.style.backgroundColor = `rgba(0, 0, 0, ${opacity * 0.9})`;
            } 
            // Swipe to Nav (Horizontal)
            else if (Math.abs(diffX) > 10) {
                activeImage.style.transform = `translateX(${diffX}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!isDragging || !activeImage) return;
            isDragging = false;
            
            if(isZoomed) return; // Don't handle swipe end logic if zoomed

            activeImage.classList.remove('dragging');
            lightbox.classList.remove('dragging');
            
            const diffX = touchCurrent.x - touchStart.x;
            const diffY = touchCurrent.y - touchStart.y;
            const timeDiff = new Date().getTime() - touchStart.time;
            
            lightbox.style.backgroundColor = '';

            // Vertical Dismiss
            if (Math.abs(diffY) > Math.abs(diffX)) {
                if (Math.abs(diffY) > 100) {
                    activeImage.style.transition = 'transform 0.2s ease-out';
                    activeImage.style.transform = `translateY(${diffY > 0 ? window.innerHeight : -window.innerHeight}px)`;
                    activeImage.style.opacity = '0';
                    setTimeout(closeLightbox, 200); 
                    return;
                }
            } 
            // Horizontal Nav
            else {
                const velocity = Math.abs(diffX) / timeDiff;
                if ((Math.abs(diffX) > 80 || velocity > 0.5) && Math.abs(diffY) < 50) {
                    if (diffX > 0) prev();
                    else next();
                    return;
                }
            }
            
            // Snap back if no action
            activeImage.style.transform = '';
            touchCurrent = { x: 0, y: 0 };
        }

        async function downloadCurrentImage() {
            if (isDownloading || currentIdx === -1) return;
            const btn = document.getElementById('downloadBtn');
            const icon = btn.querySelector('i');
            const originalIconClass = icon.className;

            try {
                isDownloading = true;
                icon.className = 'fa-solid fa-spinner fa-spin text-sm';
                let imageUrl = galleryData[currentIdx].url.replace('f_auto', 'f_jpg');
                const response = await fetch(imageUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `image-${currentIdx + 1}.jpg`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                window.open(galleryData[currentIdx].url, '_blank');
            } finally {
                isDownloading = false;
                setTimeout(() => { icon.className = originalIconClass; }, 500);
            }
        }

        lightbox.addEventListener('click', (e) => {
             if (e.target.id === 'lightbox' || e.target.id === 'imageContainer') closeLightbox();
        });

        document.getElementById('closeLightbox').addEventListener('click', closeLightbox);
        document.getElementById('nextBtn').addEventListener('click', (e) => { e.stopPropagation(); next(); });
        document.getElementById('prevBtn').addEventListener('click', (e) => { e.stopPropagation(); prev(); });

        window.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('hidden')) return;
            switch(e.key) {
                case 'Escape': closeLightbox(); break;
                case 'ArrowRight': next(); break;
                case 'ArrowLeft': prev(); break;
                case ' ': e.preventDefault(); next(); break;
            }
        });

        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) return;
            scrollTimeout = setTimeout(() => {
                if (window.scrollY > 500) backToTopBtn.classList.add('visible');
                else backToTopBtn.classList.remove('visible');
                scrollTimeout = null;
            }, 100);
        });

        renderGallery();

    </script>
</body>
</html>
